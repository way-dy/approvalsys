<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; color: #333; }
    
    .header-bar { background: linear-gradient(90deg, #6610f2 0%, #0d6efd 100%); color: white; padding: 20px 0; margin-bottom: 30px; }
    .report-card { background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); padding: 30px; margin-bottom: 30px; height: 100%; }
    
    /* Radar Chart Section */
    .chart-title { font-size: 1.2rem; font-weight: 700; color: #495057; margin-bottom: 20px; text-align: center; border-bottom: 2px solid #f1f3f5; padding-bottom: 10px; }
    
    /* Table Section */
    .table-custom th { background-color: #f8f9fa; font-size: 0.85rem; vertical-align: middle; text-align: center; color: #555; }
    .table-custom td { font-size: 0.9rem; vertical-align: middle; }
    
    .bg-blue-light { background-color: #e7f1ff; }
    .bg-purple-light { background-color: #f3e8ff; }
    
    .score-cell { font-weight: bold; text-align: center; }
    
    /* New Styles for Distribution & Header */
    .dist-header { font-size: 0.75rem; color: #666; width: 40px; }
    .avg-header { width: 60px; }
    .hidden-col { display: none; } /* ì¡°ê±´ë¶€ ìˆ¨ê¹€ìš© */
    
    /* Comments Section */
    .comment-box { border-left: 5px solid; padding: 15px; background: #fff; margin-bottom: 15px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    .comment-praise { border-color: #0d6efd; } /* íŒŒë€ìƒ‰ */
    .comment-advice { border-color: #dc3545; } /* ë¹¨ê°„ìƒ‰ */
    
    .category-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 10px; background: #eee; color: #555; margin-right: 5px; }
  </style>
</head>
<body>

  <div id="loading" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center;">
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" role="status"></div>
      <div>ê²°ê³¼ ë¦¬í¬íŠ¸ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>
  </div>

  <div class="header-bar text-center">
    <h2 class="fw-bold">[360Â° Feedback 2025]</h2>
    <h4 id="user-info-header">ë¡œë”©ì¤‘...</h4>
  </div>

  <div class="container-fluid px-4 pb-5">
    
    <div class="row g-4 mb-4">
      <div class="col-lg-5">
        <div class="report-card">
          <div class="chart-title">ğŸ“Š ì—­ëŸ‰ë³„ ì ìˆ˜ ë¶„ì„ (Category)</div>
          <div style="position: relative; height: 400px; width: 100%;">
            <canvas id="radarChart"></canvas>
          </div>
          </div>
      </div>

      <div class="col-lg-7">
        <div class="report-card" style="overflow-x: auto;">
          <div class="chart-title">ğŸ“‘ ë¬¸í•­ë³„ ìƒì„¸ ì ìˆ˜ (Detail)</div>
          <table class="table table-bordered table-hover table-custom" style="min-width: 800px;"> 
            <thead>
              <tr>
                <th rowspan="2" style="width: 8%">Category</th>
                <th rowspan="2" style="width: 25%">Question</th>
                <th colspan="6" class="bg-light">ì‘ë‹µ ë¶„í¬ (ëª…)</th> 
                <th colspan="4" class="bg-blue-light">í‰ê°€ í‰ê·  (Avg)</th>
              </tr>
              <tr>
                <th class="dist-header">N/A</th>
                <th class="dist-header">1</th>
                <th class="dist-header">2</th>
                <th class="dist-header">3</th>
                <th class="dist-header">4</th>
                <th class="dist-header">5</th>
                
                <th class="bg-blue-light avg-header" title="ì „ì²´ ë™ë£Œ í‰ê· ">ì „ì²´</th>
                <th class="bg-purple-light avg-header" title="ë³¸ì¸ íŒ€ í‰ê· " id="th-myteam">íŒ€ë‚´</th> 
                <th class="bg-light avg-header" title="íƒ€ íŒ€ í‰ê· " id="th-otherteam">íƒ€íŒ€</th> 
                <th class="bg-secondary text-white avg-header" title="ë³¸ì¸ í‰ê°€">Self</th>
              </tr>
            </thead>
            <tbody id="score-table-body">
              </tbody>
          </table>
          <div class="text-end text-muted small mt-2">
            * íŒ€ë‚´ ì‘ë‹µìê°€ 1ëª… ì´í•˜ì¸ ê²½ìš°, ìµëª…ì„± ë³´í˜¸ë¥¼ ìœ„í•´ íŒ€ë‚´/íƒ€íŒ€ í‰ê· ì€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-md-6">
        <div class="report-card">
          <div class="chart-title text-primary">ğŸ‘ ê°ì‚¬ì™€ ì¹­ì°¬í•´ ì£¼ê³  ì‹¶ì€ ê²ƒ</div>
          <div id="praise-container" style="max-height: 500px; overflow-y: auto;">
            </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="report-card">
          <div class="chart-title text-danger">ğŸ’¡ ê°œì„ ê³¼ ì¡°ì–¸ì´ í•„ìš”í•œ ë¶€ë¶„</div>
          <div id="advice-container" style="max-height: 500px; overflow-y: auto;">
            </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-5 text-muted fw-bold">
      Thank you for Feedback!
    </div>

  </div>

  <script>
    const targetEmail = <?= targetEmail ?>; //FromServer

    window.onload = function() {
      google.script.run
        .withSuccessHandler(renderReport)
        .withFailureHandler(err => alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + err))
        .getReportData(targetEmail);
    };

    function renderReport(data) {
      if(data.error) {
        alert(data.error);
        return;
      }

      // 1. í—¤ë” ì •ë³´
      document.getElementById('user-info-header').innerText = `${data.user.name} ë‹˜ _ ${data.user.team}`;

      // ---------------- [ì°¨íŠ¸ ìˆ˜ì •] ----------------
      const datasets = [
        {
          label: 'SELF',
          data: data.radar.data.self,
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13, 110, 253, 0.1)',
          borderWidth: 2
        },
        {
          label: 'ì „ì²´ ë™ë£Œ',
          data: data.radar.data.peer,
          borderColor: '#198754', // Green
          backgroundColor: 'rgba(25, 135, 84, 0.05)',
          borderWidth: 2
        }
      ];

      // ìµëª…ì„± ì¡°ê±´(null check)ì— ë”°ë¼ ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ ì°¨íŠ¸ ì¶”ê°€
      if (data.radar.data.myTeam) {
         datasets.push({
           label: 'ë‚´ íŒ€',
           data: data.radar.data.myTeam,
           borderColor: '#6f42c1', // Purple
           borderDash: [5, 5], // ì ì„ 
           borderWidth: 2,
           fill: false
         });
      }
      if (data.radar.data.otherTeam) {
         datasets.push({
           label: 'íƒ€ íŒ€',
           data: data.radar.data.otherTeam,
           borderColor: '#adb5bd', // Gray
           borderDash: [2, 2], // ì´˜ì´˜í•œ ì ì„ 
           borderWidth: 1,
           fill: false
         });
      }

      const ctx = document.getElementById('radarChart').getContext('2d');
      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: data.radar.labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              angleLines: { display: true },
              suggestedMin: 0,
              suggestedMax: 5,
              ticks: { stepSize: 1 }
            }
          },
          plugins: {
            legend: { position: 'top', labels: { boxWidth: 12, font: { size: 11 } } }
          }
        }
      });

      // ---------------- [í…Œì´ë¸” ìˆ˜ì •] ----------------
      const tbody = document.getElementById('score-table-body');
      let lastCategory = '';
      
      // ë§Œì•½ ë°ì´í„° ì¤‘ í•˜ë‚˜ë¼ë„ myTeamì´ nullì´ë©´ ì»¬ëŸ¼ ì „ì²´ ìˆ¨ê¹€ (í—¤ë” ì²˜ë¦¬)
      // data.tableì€ {index: {avg: {...}, dist: {...}}, ...} í˜•íƒœë¼ê³  ê°€ì •
      const hasTeamData = Object.values(data.table).some(t => t.avg.myTeam !== null && t.avg.myTeam !== undefined);
      
      if (!hasTeamData) {
        document.getElementById('th-myteam').style.display = 'none';
        document.getElementById('th-otherteam').style.display = 'none';
      }

      data.questions.forEach((q, idx) => {
        const stats = data.table[q.index];
        const tr = document.createElement('tr');
        
        // ì¹´í…Œê³ ë¦¬ í‘œì‹œ (ì¤‘ë³µ ì œê±°)
        let catHtml = `<span class="fw-bold small text-secondary">${q.category}</span>`;
        if (q.category === lastCategory) {
          catHtml = `<span class="small text-muted" style="opacity:0.3">"</span>`;
        } else {
          lastCategory = q.category;
        }

        // ë¶„í¬ ë Œë”ë§ í—¬í¼ (ê°’ì´ ìˆìœ¼ë©´ ì§„í•˜ê²Œ, ì—†ìœ¼ë©´ -)
        // key: '0'(N/A), '1', '2', '3', '4', '5'
        const renderDist = (key) => {
           const count = stats.dist[key] || 0;
           return count > 0 
             ? `<td class="text-center small fw-bold text-primary bg-light">${count}</td>` 
             : `<td class="text-center small text-muted">-</td>`;
        };

        // íŒ€ í‰ê·  ë°ì´í„°ê°€ null(ìµëª…ì„±)ì´ë©´ ì…€ì„ ìˆ¨ê¹€ (í—¤ë”ì™€ ë™ì¼í•˜ê²Œ display:none í•˜ê±°ë‚˜ ìƒì„± ì•ˆí•¨)
        // ì—¬ê¸°ì„œëŠ” í—¤ë”ë¥¼ ìˆ¨ê²¼ìœ¼ë¯€ë¡œ, ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì…€ ìì²´ë¥¼ ìƒì„±í•˜ì§€ ì•Šì•„ì•¼ ì—´ì´ ë§ìŒ.
        let teamCells = '';
        if (hasTeamData) {
          teamCells = `
            <td class="score-cell bg-purple-light">${stats.avg.myTeam !== null ? stats.avg.myTeam : '-'}</td>
            <td class="score-cell bg-light text-muted">${stats.avg.otherTeam !== null ? stats.avg.otherTeam : '-'}</td>
          `;
        }

        tr.innerHTML = `
          <td class="text-center align-middle bg-light">${catHtml}</td>
          <td><span class="badge bg-light text-dark border me-1">${q.index + 1}</span> ${q.text}</td>
          
          ${renderDist('0')}
          ${renderDist('1')}
          ${renderDist('2')}
          ${renderDist('3')}
          ${renderDist('4')}
          ${renderDist('5')}

          <td class="score-cell bg-blue-light">${stats.avg.peer}</td>
          ${teamCells}
          <td class="score-cell bg-secondary text-white">${stats.avg.self}</td>
        `;
        tbody.appendChild(tr);
      });

      // 4. ì½”ë©˜íŠ¸ ë Œë”ë§ (ê¸°ì¡´ ìœ ì§€)
      renderComments('praise-container', data.comments.praise, 'ì‘ì„±ëœ ì¹­ì°¬ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'comment-praise');
      renderComments('advice-container', data.comments.advice, 'ì‘ì„±ëœ ì¡°ì–¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'comment-advice');

      document.getElementById('loading').style.display = 'none';
    }

    function renderComments(containerId, list, emptyMsg, className) {
      const container = document.getElementById(containerId);
      if (!list || list.length === 0) {
        container.innerHTML = `<div class="text-center text-muted py-4">${emptyMsg}</div>`;
        return;
      }
      
      list.forEach(txt => {
        const div = document.createElement('div');
        div.className = `comment-box ${className}`;
        div.innerText = txt;
        container.appendChild(div);
      });
    }
  </script>
</body>
</html>